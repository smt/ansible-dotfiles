# file: roles/dotfiles/tasks/smt.yml

---
# files ------------------------------------------------------------------- {{{
- name: smt | mkdir -p dotfiles.smt.directories
  file: name={{ item }} state=directory
  with_items: dotfiles.smt.directories
# /files ------------------------------------------------------------------ }}}

# repos ------------------------------------------------------------------- {{{
- name: smt | git clone dotfiles.smt.git.repos
  git: repo={{ item.repo }} dest={{ item.dest }} accept_hostkey=true depth=1 ssh_opts="-o StrictHostKeyChecking=no"
  with_items: dotfiles.smt.git.repos
# /repos ------------------------------------------------------------------ }}}

# fzf --------------------------------------------------------------------- }}}
- name: smt | fzf install
  shell: "{{ dotfiles.smt.fzf.commands.install }}"
  args:
    chdir: "{{ dotfiles.smt.fzf.directories.root }}"
# /fzf -------------------------------------------------------------------- }}}

# rbenv ------------------------------------------------------------------- {{{
- name: smt | rbenv install dotfiles.smt.ruby.version
  shell: "./{{ dotfiles.smt.rbenv.commands.rbenv_install_ruby }}"
  environment:
    RBENV_ROOT: "{{ dotfiles.smt.rbenv.directories.root }}"
  args:
    chdir: "{{ dotfiles.smt.rbenv.directories.bin }}"
    creates: "{{ dotfiles.smt.rbenv.directories }}/{{ smt.ruby.version }}"

- name: smt | rbenv global dotfiles.smt.ruby.version
  shell: "./{{ dotfiles.smt.rbenv.commands.rbenv_global_ruby }}"
  environment:
    RBENV_ROOT: "{{ dotfiles.smt.rbenv.directories.root }}"
  args:
    chdir: "{{ dotfiles.smt.rbenv.directories.bin }}"

- name: smt | gem install bundler
  shell: "./{{ dotfiles.smt.rbenv.commands.gem_install_bundler }}"
  environment:
    RBENV_ROOT: "{{ dotfiles.smt.rbenv.directories.root }}"
  args:
    chdir: "{{ dotfiles.smt.rbenv.directories.shims }}"
  ignore_errors: true
# /rbenv ------------------------------------------------------------------ }}}

# dotfiles ---------------------------------------------------------------- {{{
- name: smt | rake stat
  stat: "{{ dotfiles.smt.rbenv.directories.shims }}/{{ dotfiles.smt.dotfiles.commands.install }}"
  register: rake
- name: smt | rake install dotfiles
  environment:
    RBENV_ROOT: "{{ dotfiles.smt.rbenv.directories.root }}"
  shell: "{{ dotfiles.smt.rbenv.directories.shims }}/{{ dotfiles.smt.dotfiles.commands.install }}"
  args:
    chdir: "{{ dotfiles.smt.dotfiles.directories.root }}"
    creates: "{{ smt.home }}/.fishrc.local"
  when: rake.stat.isreg is defined and rake.stat.isreg

- name: smt | tmux.conf stat
  stat: "{{ smt.home }}/.tmux.{{ system }}.conf"
  register: tmux_conf
- name: smt | ln -s ~/.tmux.system.conf ~/.tmux.conf
  file: "src={{ smt.home }}/.tmux.{{ system }}.conf dest={{ smt.home }}/.tmux.conf state=link"
  when: tmux_conf.stat.islnk is not defined

- name: smt | chsh -s fish
  shell: "dscl . change /users/{{ smt.user.name }} UserShell /bin/bash {{ smt.user.shell }}"
  sudo: true
  args:
    executable: "/bin/bash"
  ignore_errors: true
# /dotfiles --------------------------------------------------------------- }}}

# nvm --------------------------------------------------------------------- {{{
- name: smt | nvm prefix
  shell: "brew --prefix nvm"
  register: nvm_prefix
  ignore_errors: true
  args:
    executable: "/bin/bash"

- name: smt | nvm root stat
  stat: "path={{ dotfiles.smt.nvm.directories.root }}"
  register: nvm_stat

- name: smt | nvm root create
  shell: "mkdir -p {{ dotfiles.smt.nvm.directories.root }}"
  args:
    chdir: "{{ smt.home }}"
    creates: "{{ dotfiles.smt.nvm.directories.root }}"

- name: smt | nvm link create
  shell: "ln -s {{ nvm_prefix.stdout }}/nvm.sh {{ dotfiles.smt.nvm.executables.nvm }}"
  args:
    chdir: "{{ smt.home }}"
  when: nvm_stat.stat.isdir is not defined

- name: smt | nvm install
  shell: "{{ dotfiles.smt.nvm.executables.nvm }} install {{ item }}"
  with_items: dotfiles.smt.nvm.versions
  environment:
    NVM_DIR: "{{ dotfiles.smt.nvm.directories.root }}"
  when: nvm_stat.stat.isdir is not defined
  args:
    executable: "/bin/bash"
    chdir: "{{ smt.home }}"
    creates: "{{ dotfiles.smt.nvm.directories.root }}/versions/node"

- name: smt | nvm alias default
  shell: "{{ dotfiles.smt.nvm.executables.nvm }} alias default {{ smt.nvm.default }}"
  environment:
    NVM_DIR: "{{ dotfiles.smt.nvm.directories.root }}"
  when: nvm_stat.stat.isdir is not defined
  args:
    executable: "/bin/bash"
    chdir: "{{ smt.home }}"
    creates: "{{ dotfiles.smt.nvm.directories.root }}/alias/default"
# /nvm -------------------------------------------------------------------- }}}

# npm --------------------------------------------------------------------- }}}
- name: smt | npm install
  shell: "npm install -g {{ item }}"
  with_items: dotfiles.smt.npm.modules
  environment:
    NVM_DIR: "{{ dotfiles.smt.nvm.directories.root }}"
  args:
    executable: "/bin/bash"
    chdir: "{{ smt.home }}"
# /npm -------------------------------------------------------------------- }}}

# vim --------------------------------------------------------------------- {{{
- name: smt | get_url plug.vim
  get_url: url={{ dotfiles.smt.vim.plug.url }} dest={{ dotfiles.smt.vim.plug.dest }}

- name: smt | vim +PlugInstall +qall
  shell: "{{ dotfiles.smt.vim.plug.commands.install }}"
  args:
    chdir: "{{ smt.home }}"
    creates: "{{ dotfiles.smt.vim.plug.files.plugged }}"
# /vim -------------------------------------------------------------------- {{{
